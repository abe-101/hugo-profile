<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=icon href=../../images/fav.png type=image/gif><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-216916075-1','auto');ga('send','pageview');}</script><link rel=stylesheet href=../../css/bootstrap.min.css media=all><link rel=stylesheet href=../../css/all.min.css media=all><link rel=stylesheet href=../../css/fontawesome.min.css media=all><link rel=stylesheet href=../../css/v3/darkmode.css media=all><style>html{scrollbar-width:thin;scrollbar-color:#6c757d transparent}::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:#6c757d}</style><link rel=stylesheet href=../../css/v3/navbar-footer.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;1,100;1,300&display=swap" rel=stylesheet><script src=../../js/popper.min.js></script><meta name=description content="Raspberry Pi Encrypted Boot With Ssh"><title>Raspberry Pi Encrypted Boot With Ssh</title><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-216916075-1','auto');ga('send','pageview');}</script><meta property="og:title" content="Raspberry Pi Encrypted Boot With Ssh"><meta property="og:description" content="Raspberry Pi Encrypted Boot With Ssh"><meta property="og:type" content="article"><meta property="og:url" content="https://habet.dev/blog/raspberry-pi-encrypted-boot-with-ssh/"><meta property="og:image" content="https://habet.dev/images/site-feature-image.jpg"><meta property="article:published_time" content="2021-12-23T00:39:34-05:00"><meta property="article:modified_time" content="2021-12-23T00:39:34-05:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://habet.dev/images/site-feature-image.jpg"><meta name=twitter:title content="Raspberry Pi Encrypted Boot With Ssh"><meta name=twitter:description content="Raspberry Pi Encrypted Boot With Ssh"><link href=../../css/v3/post.css rel=stylesheet></head><body class=text-dark><script src=../../js/jquery.slim.min.js></script><script src=../../js/bootstrap.min.js></script><div class=container><nav class="pt-3 navbar navbar-expand-lg navbar-light" data-aos=fade-down data-aos-easing=linear data-aos-duration=500><a class=navbar-brand href=../../><img src=../../images/fav.png width=30 height=30 class="d-inline-block align-top">
Abe's Portfolio</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navbarNavDropdown aria-controls=navbarNavDropdown aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNavDropdown><ul class="navbar-nav ml-auto text-center"><li class="nav-item navbar-text"><a class="nav-link text-dark" href=../../#about aria-label=about>About</a></li><li class="nav-item navbar-text"><a class="nav-link text-dark" href=../../#projects aria-label=projects>Projects</a></li><li class="nav-item navbar-text"><a class="nav-link text-dark" href=../../#contact aria-label=contact>Contact</a></li><li class="nav-item navbar-text"><a class="nav-link text-dark" href=../../blog aria-label=Blog>Blog</a></li><li class="nav-item navbar-text"><div class="custom-control custom-switch"><input type=checkbox class=custom-control-input id=customSwitch1 autocomplete=on>
<label class="pt-2 darkmode-label" for=customSwitch1 style=cursor:pointer><i class="fas fa-lg fa-moon"></i><i class="fas fa-lg fa-sun d-none text-warning"></i></label></div></li></ul></div></nav></div><section style=font-family:roboto,sans-serif><div class="bottom-share d-none"><div class="my-1 mb-3 share-container"><div class="d-block my-1 text-center" data-toggle=tooltip data-placement=left title="Tooltip on left"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48" height="48"><path fill="#03a9f4" d="M42 37c0 2.762-2.239 5-5 5H11c-2.762.0-5-2.238-5-5V11c0-2.762 2.238-5 5-5h26c2.761.0 5 2.238 5 5V37z"/><path fill="#fff" d="M36 17.12c-.882.391-1.999.758-3 .88 1.018-.604 2.633-1.862 3-3-.951.559-2.671 1.156-3.793 1.372C31.311 15.422 30.033 15 28.617 15 25.897 15 24 17.305 24 20v2c-4 0-7.9-3.047-10.327-6-.427.721-.667 1.565-.667 2.457.0 1.819 1.671 3.665 2.994 4.543-.807-.025-2.335-.641-3-1 0 .016.0.036.0.057.0 2.367 1.661 3.974 3.912 4.422C16.501 26.592 16 27 14.072 27c.626 1.935 3.773 2.958 5.928 3-1.686 1.307-4.692 2-7 2-.399.0-.615.022-1-.023C14.178 33.357 17.22 34 20 34c9.057.0 14-6.918 14-13.37.0-.212-.007-.922-.018-1.13C34.95 18.818 35.342 18.104 36 17.12"/></svg></div><div class="d-block my-1 text-center" data-toggle=tooltip data-placement=left title="Tooltip on left"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="48" data-name="Layer 1" viewBox="0 0 32 32"><path fill="#ea4435" d="M16.58 19.1068l-12.69-8.0757A3 3 0 017.1109 5.97l9.31 5.9243L24.78 6.0428A3 3 0 0128.22 10.9579z"/><path fill="#00ac47" d="M25.5 5.5h4a0 0 0 010 0v18a3 3 0 01-3 3h0a3 3 0 01-3-3V7.5a2 2 0 012-2z" transform="rotate(180 26.5 16)"/><path fill="#ffba00" d="M29.4562 8.0656c-.0088-.06-.0081-.1213-.0206-.1812-.0192-.0918-.0549-.1766-.0823-.2652a2.9312 2.9312.0 00-.0958-.2993c-.02-.0475-.0508-.0892-.0735-.1354A2.9838 2.9838.0 0028.9686 6.8c-.04-.0581-.09-.1076-.1342-.1626a3.0282 3.0282.0 00-.2455-.2849c-.0665-.0647-.1423-.1188-.2146-.1771a3.02 3.02.0 00-.24-.1857c-.0793-.0518-.1661-.0917-.25-.1359-.0884-.0461-.175-.0963-.267-.1331-.0889-.0358-.1837-.0586-.2766-.0859s-.1853-.06-.2807-.0777a3.0543 3.0543.0 00-.357-.036c-.0759-.0053-.1511-.0186-.2273-.018a2.9778 2.9778.0 00-.4219.0425c-.0563.0084-.113.0077-.1689.0193a33.211 33.211.0 00-.5645.178c-.0515.022-.0966.0547-.1465.0795A2.901 2.901.0 0023.5 8.5v5.762l4.72-3.3043a2.8878 2.8878.0 001.2359-2.8923z"/><path fill="#4285f4" d="M5.5 5.5h0a3 3 0 013 3v18a0 0 0 010 0h-4a2 2 0 01-2-2V8.5a3 3 0 013-3z"/><path fill="#c52528" d="M2.5439 8.0656c.0088-.06.0081-.1213.0206-.1812.0192-.0918.0549-.1766.0823-.2652A2.9312 2.9312.0 012.7426 7.32c.02-.0475.0508-.0892.0736-.1354A2.9719 2.9719.0 013.0316 6.8c.04-.0581.09-.1076.1342-.1626a3.0272 3.0272.0 01.2454-.2849c.0665-.0647.1423-.1188.2147-.1771a3.0005 3.0005.0 01.24-.1857c.0793-.0518.1661-.0917.25-.1359A2.9747 2.9747.0 014.3829 5.72c.089-.0358.1838-.0586.2766-.0859s.1853-.06.2807-.0777a3.0565 3.0565.0 01.357-.036c.076-.0053.1511-.0186.2273-.018a2.9763 2.9763.0 01.4219.0425c.0563.0084.113.0077.169.0193a2.9056 2.9056.0 01.286.0888 2.9157 2.9157.0 01.2785.0892c.0514.022.0965.0547.1465.0795a2.9745 2.9745.0 01.3742.21A2.9943 2.9943.0 018.5 8.5v5.762L3.78 10.9579A2.8891 2.8891.0 012.5439 8.0656z"/></svg></div><div class="d-block my-1 text-center" data-toggle=tooltip data-placement=left title="Tooltip on left"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="38" height="48"><path fill="#4caf50" d="M8.002.0h-.004C3.587.0.0 3.588.0 8a7.94 7.94.0 001.523 4.689l-.997 2.972 3.075-.983A7.93 7.93.0 008.002 16C12.413 16 16 12.411 16 8s-3.587-8-7.998-8z"/><path fill="#fafafa" d="M12.657 11.297c-.193.545-.959.997-1.57 1.129-.418.089-.964.16-2.802-.602-2.351-.974-3.865-3.363-3.983-3.518-.113-.155-.95-1.265-.95-2.413s.583-1.707.818-1.947c.193-.197.512-.287.818-.287.099.0.188.005.268.009.235.01.353.024.508.395.193.465.663 1.613.719 1.731.057.118.114.278.034.433-.075.16-.141.231-.259.367s-.23.24-.348.386c-.108.127-.23.263-.094.498.136.23.606.997 1.298 1.613.893.795 1.617 1.049 1.876 1.157.193.08.423.061.564-.089.179-.193.4-.513.625-.828.16-.226.362-.254.574-.174.216.075 1.359.64 1.594.757.235.118.39.174.447.273.056.099.056.564-.137 1.11z"/></svg></div></div><div class=text-center data-toggle=tooltip data-placement=left title="Share this article"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 25 25"><g transform="translate(0 -1027.362)"><circle cx="657.054" cy="437.094" r="15.268" fill="#9257a2" fill-rule="evenodd" transform="translate(-525.439 682.007) scale(.81871)"/><path fill="#6c4676" style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal" d="M12.943359 24.984375A12.5 12.5.0 0013.384766 24.96875 12.5 12.5.0 0014.625 24.818359 12.5 12.5.0 0015.84375 24.544922 12.5 12.5.0 0017.029297 24.150391 12.5 12.5.0 0018.169922 23.640625 12.5 12.5.0 0019.253906 23.017578 12.5 12.5.0 0020.269531 22.291016 12.5 12.5.0 0021.208984 21.466797 12.5 12.5.0 0022.060547 20.552734 12.5 12.5.0 0022.816406 19.558594 12.5 12.5.0 0023.470703 18.492188 12.5 12.5.0 0024.013672 17.367188 12.5 12.5.0 0024.441406 16.193359 12.5 12.5.0 0024.496094 15.974609L14.265625 5.7441406C13.812473 5.2910406 13.187396 5.0097656 12.5 5.0097656 11.12521 5.0097656 10 6.1349656 10 7.5097656 10 7.5307656 10.005259 7.5493125 10.005859 7.5703125 9.4896699 7.8077125 9.0133544 8.1147296 8.5878906 8.4804688 8.374766 8.6636758 8.1738297 8.8614634 7.9882812 9.0722656 7.0619905 10.124095 6.5 11.499953 6.5 13.009766 6.5 13.488466 6.573385 13.948784 6.6796875 14.396484 5.9748502 14.839884 5.5 15.620266 5.5 16.509766 5.5 17.197166 5.7812253 17.822291 6.234375 18.275391L12.943359 24.984375z" color="#000" font-family="sans-serif" font-weight="400" transform="translate(0 1027.362)"/><path fill="#fff" d="m7.9941406 1c-1.3747895.0-2.5 1.1252-2.5 2.5.0.02072.00535.039943.00586.060547C3.4352817 4.5101164 1.9941406 6.5842949 1.9941406 9c0 .4787281.073385.9389814.1796875 1.386719C1.4689908 10.830108.99414062 11.610545.99414062 12.5c0 1.3748 1.12521048 2.5 2.49999998 2.5.6665407.0 1.2712865-.268072 1.7207032-.697266C6.0479519 14.74009 6.9900874 15 7.9941406 15 8.9981981 15 9.9421095 14.741984 10.775391 14.304688 11.224611 14.732762 11.828584 15 12.494141 15c1.374789.0 2.5-1.1252 2.5-2.5.0-.887901-.472993-1.667522-1.175782-2.111328C13.924794 9.941126 13.994141 9.4787929 13.994141 9c0-2.4173981-1.439125-4.4947611-3.50586-5.4433594 446e-6-.019294.0059-.037245.0059-.056641.0-1.3748-1.1252108-2.5-2.5000004-2.5zm0 1c.8343495.0 1.5.6657 1.5 1.5.0.8344-.6656505 1.5-1.5 1.5-.8343494.0-1.5-.6656-1.5-1.5.0-.8343.6656506-1.5 1.5-1.5zM5.7363281 4.5507812C6.1363719 5.4015827 6.9962448 6 7.9941406 6 8.9914269 6 9.8515843 5.4027009 10.251953 4.5527344 11.874506 5.3778725 12.994141 7.0495149 12.994141 9c0 .358063-.04812.702711-.119141 1.039062C12.74983 10.019561 12.62455 10 12.494141 10c-1.37479.0-2.5000004 1.1252-2.5000004 2.5.0.347738.073318.676884.2031254.978516C9.5317018 13.806899 8.7887215 14 7.9941406 14 7.1996182 14 6.4561816 13.808725 5.7910156 13.480469 5.9212525 13.178414 5.9941406 12.848348 5.9941406 12.5c0-1.3748-1.1252104-2.5-2.5-2.5C3.3643933 10 3.2397998 10.01975 3.1152344 10.03906 3.0437876 9.7026723 2.9941406 9.3583587 2.9941406 9c0-1.9503184 1.1196952-3.6242663 2.7421875-4.4492188zM3.4941406 11c.8343495.0 1.5.6657 1.5 1.5.0.8344-.6656505 1.5-1.5 1.5-.8343494.0-1.5-.6656-1.5-1.5.0-.8343.6656506-1.5 1.5-1.5zm9.0000004.0c.834349.0 1.5.6657 1.5 1.5.0.8344-.665651 1.5-1.5 1.5-.83435.0-1.5-.6656-1.5-1.5.0-.8343.66565-1.5 1.5-1.5z" color="#000" font-family="sans-serif" font-weight="400" overflow="visible" transform="translate(4.506 1031.372)" style="line-height:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;block-progression:tb;isolation:auto;mix-blend-mode:normal"/></g></svg></div></div><div class=container><div class="row blog-page-color"><div class="col-md-9 py-4 px-0"><div class="rounded shadow bg-light p-3 px-md-5 bg-light"><h1 class="pb-2 text-center">Raspberry Pi Encrypted Boot With Ssh</h1><article><p>Please note this project is a fork from <a href=https://github.com/ViRb3/pi-encrypted-boot-ssh>ViRb3</a>, I&rsquo;ve made some minor changes here.</p><blockquote><p>Tested on Raspberry Pi <a href=https://www.raspberrypi.org/products/raspberry-pi-3-model-b/>3B</a> & <a href=https://www.raspberrypi.org/products/raspberry-pi-4-model-b/>4B</a> with <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 21.04</a> & <a href=https://raspi.debian.net/tested>Debian 11</a></p></blockquote><h2 id=introduction>Introduction</h2><p>This guide will show you how to encrypt your Raspberry Pi&rsquo;s root partition and set up an <a href=https://en.wikipedia.org/wiki/Initial_ramdisk>initramfs</a> that will prompt for the password, decrypt the partition and gracefully resume boot. You will also learn how to enable SSH during this pre-boot stage, allowing you to unlock the partition remotely.</p><p>While the steps are written for the Raspberry Pi, they should be easily transferrable to other SBCs and computers as a whole.</p><p>This guide operates directly on an image file and therefore does not require an SD card for the setup. The resulting image can be flashed to an SD card as usual.</p><h2 id=requirements>Requirements</h2><ul><li><p>A Raspberry Pi Linux image (e.g. <a href=https://ubuntu.com/download/raspberry-pi>Ubuntu Server 21.04</a>)</p></li><li><p>A computer (host) running Linux (e.g. <a href=https://xubuntu.org/download>Xubuntu 21.04</a>)</p><blockquote><p>⚠️ <strong>NOTE:</strong> Your host&rsquo;s Linux should be as similar as possible to the Raspberry Pi&rsquo;s Linux. If you are preparing Ubuntu 21.04 for the Raspberry Pi, use the same version on the host, otherwise you may encounter issues inside the chroot.<br>Alternatively, if you don&rsquo;t have the same host you can boot up the raspberry pi and prepare the image from there.</p></blockquote></li></ul><h2 id=on-the-host>On the host</h2><p>Install dependencies:</p><blockquote><p>You can skip <code>qemu-user-static</code> if your host Linux&rsquo;s architecture matches that of the Raspberry Pi&rsquo;s Linux image.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>apt update
apt install -y kpartx cryptsetup-bin qemu-user-static
</code></pre></div><p>Create two copies of the Raspberry Pi&rsquo;s Linux image - one to read from (base), and one to write to (target):</p><ul><li>ubuntu-base.img</li><li>ubuntu-target.img</li></ul><p>Map both images as devices, ensuring the base is readonly:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kpartx -ar <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/ubuntu-base.img&#34;</span>
kpartx -a <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/ubuntu-target.img&#34;</span>
</code></pre></div><p>If your system automatically mounted any partitions, unmount them:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>umount /media/**/*
</code></pre></div><p>Run <a href=https://linux.die.net/man/8/lsblk>lsblk</a> and verify the process was successful - you should see two loopback devices, each with two partitions:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT <span style=color:#75715e># COMMENT</span>
loop0       7:0    <span style=color:#ae81ff>0</span>  3.3G  <span style=color:#ae81ff>0</span> loop            <span style=color:#75715e># ubuntu-base.img</span>
├─loop0p1 253:0    <span style=color:#ae81ff>0</span>  256M  <span style=color:#ae81ff>0</span> part            <span style=color:#75715e># ├─ boot</span>
└─loop0p2 253:1    <span style=color:#ae81ff>0</span>    3G  <span style=color:#ae81ff>0</span> part            <span style=color:#75715e># └─ root</span>
loop1       7:1    <span style=color:#ae81ff>0</span>  3.3G  <span style=color:#ae81ff>1</span> loop            <span style=color:#75715e># ubuntu-target.img</span>
├─loop1p1 253:2    <span style=color:#ae81ff>0</span>  256M  <span style=color:#ae81ff>1</span> part            <span style=color:#75715e># ├─ boot</span>
└─loop1p2 253:3    <span style=color:#ae81ff>0</span>    3G  <span style=color:#ae81ff>1</span> part            <span style=color:#75715e># └─ root</span>
</code></pre></div><p>Mount the base image&rsquo;s root partition:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkdir -p /mnt/original/
mount /dev/mapper/loop0p2 /mnt/original/
</code></pre></div><p>Replace the target image&rsquo;s root partition with a new, encrypted partition:</p><blockquote><p>⚠️ <strong>NOTE:</strong></p><p>In this example we will use <a href=https://github.com/google/adiantum>aes-adiantum</a> as the encryption method since it is much faster on targets that lack hardware AES acceleration. Ensure that both the host&rsquo;s and Pi&rsquo;s kernel (>= <a href=https://kernelnewbies.org/Linux_5.0#Adiantum_file_system_encryption_for_low_power_devices>5.0.0</a>, must include .ko) and <a href=https://linux.die.net/man/8/cryptsetup>cryptsetup</a> (>= <a href=https://mirrors.edge.kernel.org/pub/linux/utils/cryptsetup/v2.0/v2.0.6-ReleaseNotes>2.0.6</a>) support your encryption method.</p><p>By default cryptsetup will benchmark the system that is creating the encrypted partition to find suitable memory difficulty. This is usually half of the machine&rsquo;s available RAM. Since the calculation is is done on the host, it is very likely to exceed the Raspberry Pi&rsquo;s maximum RAM and make it impossible to unlock the partition. To prevent this, set the <a href=https://linux.die.net/man/8/cryptsetup>&ndash;pbkdf-memory</a> argument to something less than the Pi&rsquo;s maximum RAM.</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cryptsetup luksFormat -c xchacha20,aes-adiantum-plain64 --pbkdf-memory <span style=color:#ae81ff>512000</span> /dev/mapper/loop1p2
</code></pre></div><p>Open (decrypt) the new partition:</p><pre><code>cryptsetup open /dev/mapper/loop1p2 crypted
</code></pre><p>Then format and mount it:</p><pre><code>mkfs.ext4 /dev/mapper/crypted
mkdir -p /mnt/chroot/
mount /dev/mapper/crypted /mnt/chroot/
</code></pre><p>Copy the base image&rsquo;s root partition files to the target image&rsquo;s new, encrypted root partition. You can use <a href=https://linux.die.net/man/1/dd>dd</a>, but <a href=https://linux.die.net/man/1/rsync>rsync</a> is faster:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>rsync --archive --hard-links --acls --xattrs --one-file-system --numeric-ids --info<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;progress2&#34;</span> /mnt/original/* /mnt/chroot/
</code></pre></div><p>Set up a <a href=https://linux.die.net/man/1/chroot>chroot</a> by mounting the target image&rsquo;s boot partition and required virtual filesystems from the host:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkdir -p /mnt/chroot/boot/
mount /dev/mapper/loop1p1 /mnt/chroot/boot/
mount -t proc none /mnt/chroot/proc/
mount -t sysfs none /mnt/chroot/sys/
mount -o bind /dev /mnt/chroot/dev/
mount -o bind /dev/pts /mnt/chroot/dev/pts/
</code></pre></div><p>Enter the chroot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>LANG<span style=color:#f92672>=</span>C chroot /mnt/chroot/
</code></pre></div><h2 id=in-the-chroot>In the chroot</h2><h3 id=prepare>Prepare</h3><p>Install dependencies:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>apt update
apt install -y busybox cryptsetup dropbear-initramfs
</code></pre></div><p>If the chroot cannot resolve hostnames, you might have a symlinked <a href=https://linux.die.net/man/5/resolv.conf>resolv.conf</a> that is invalid in the chroot context. To work around this, back it up and create a simple nameserver replacement:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mv /etc/resolv.conf /etc/resolv.conf.bak
echo <span style=color:#e6db74>&#34;nameserver 1.1.1.1&#34;</span> &gt; /etc/resolv.conf
</code></pre></div><h3 id=device-configuration>Device configuration</h3><p>Run <a href=https://linux.die.net/man/8/blkid>blkid</a> and note the details of your encrypted and decrypted partitions:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e># encrypted</span>
/dev/mapper/loop1p2: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;crypto_LUKS&#34;</span> PARTUUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cccccccc-cc&#34;</span>
<span style=color:#75715e># decrypted</span>
/dev/mapper/crypted: UUID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb&#34;</span> BLOCK_SIZE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;4096&#34;</span> TYPE<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ext4&#34;</span>
</code></pre></div><p>Edit <a href=https://linux.die.net/man/5/fstab>/etc/fstab</a> and replace the root entry with your decrypted (virtual) partition&rsquo;s device name:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>/dev/mapper/crypted /               ext4  discard,errors<span style=color:#f92672>=</span>remount-ro <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>
LABEL<span style=color:#f92672>=</span>system-boot   /boot/firmware  vfat  defaults                  <span style=color:#ae81ff>0</span> <span style=color:#ae81ff>1</span>
</code></pre></div><p>Edit <a href=https://linux.die.net/man/5/crypttab>/etc/crypttab</a> and add an entry with your encrypted (raw) partition&rsquo;s UUID:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>crypted UUID<span style=color:#f92672>=</span>aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa none luks,initramfs
</code></pre></div><p>Edit <code>/boot/cmdline.txt</code> and update the root entry:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>root<span style=color:#f92672>=</span>/dev/mapper/crypted cryptdevice<span style=color:#f92672>=</span>UUID<span style=color:#f92672>=</span>aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:crypted
</code></pre></div><h3 id=cryptsetup>Cryptsetup</h3><p>Edit the cryptsetup initramfs hook to ensure cryptsetup ends up in the initramfs:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;CRYPTSETUP=y&#34;</span> &gt;&gt; /etc/cryptsetup-initramfs/conf-hook
</code></pre></div><p>At least on Ubuntu Server 21.04, the <a href=https://manpages.ubuntu.com/manpages/xenial/man8/initramfs-tools.8.html>initramfs-tools</a> <code>cryptroot</code> hook will resolve any UUIDs to device names during initramfs generation. This is a problem because the device names will likely differ between the host and the Raspberry Pi, resulting in failure to boot. To work around this, apply the following patch:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-patch data-lang=patch>patch --no-backup-if-mismatch /usr/share/initramfs-tools/hooks/cryptroot &lt;&lt; &#39;EOF&#39;
<span style=color:#f92672>--- cryptroot
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ cryptroot
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -33,7 +33,7 @@
</span><span style=color:#75715e></span>         printf &#39;%s\0&#39; &#34;$target&#34; &gt;&gt;&#34;$DESTDIR/cryptroot/targets&#34;
         crypttab_find_entry &#34;$target&#34; || return 1
         crypttab_parse_options --missing-path=warn || return 1
<span style=color:#f92672>-        crypttab_print_entry
</span><span style=color:#f92672></span><span style=color:#a6e22e>+        printf &#39;%s %s %s %s\n&#39; &#34;$_CRYPTTAB_NAME&#34; &#34;$_CRYPTTAB_SOURCE&#34; &#34;$_CRYPTTAB_KEY&#34; &#34;$_CRYPTTAB_OPTIONS&#34; &gt;&amp;3
</span><span style=color:#a6e22e></span>     fi
 }
EOF
</code></pre></div><p>If you are planning to run on a Raspberry Pi 3, the default timeout when waiting for decryption (e.g. 10 seconds) may be too short and you may get a timeout error. To work around this, bump the timeout:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sed -i <span style=color:#e6db74>&#39;s/^TIMEOUT=.*/TIMEOUT=100/g&#39;</span> /usr/share/cryptsetup/initramfs/bin/cryptroot-unlock
</code></pre></div><h3 id=ssh>SSH</h3><p>Write your SSH public key inside dropbear&rsquo;s <code>authorized_keys</code> and fix permissions:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo <span style=color:#e6db74>&#34;/REDACTED/&#34;</span> &gt; /etc/dropbear-initramfs/authorized_keys
chmod <span style=color:#ae81ff>0600</span> /etc/dropbear-initramfs/authorized_keys
</code></pre></div><h3 id=build-initramfs>Build initramfs</h3><p>Note whether you already have an initramdisk - it should be under <code>/boot/initrd.img</code>. This will decide whether you need to update your boot config later on.</p><p>Note your kernel version. If there are multiple, choose the one you want to run:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>ls /lib/modules/
</code></pre></div><p>Build the new initramdisk using the kernel version from above, overwriting the old initramdisk if it exists:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mkinitramfs -o /boot/initrd.img <span style=color:#e6db74>&#34;5.4.0-1008-raspi&#34;</span>
</code></pre></div><p>If you had an initramdisk when you checked in the beginning of this section, then your system is already configured to use an initramfs - no changes are necessary. Otherwise, add an entry to your boot config:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo initramfs initrd.img &gt;&gt; /boot/config.txt
</code></pre></div><h3 id=cleanup>Cleanup</h3><p>Revert any changes if you have made them before:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mv /etc/resolv.conf.bak /etc/resolv.conf
</code></pre></div><p>Sync and exit the chroot:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sync
history -c <span style=color:#f92672>&amp;&amp;</span> exit
</code></pre></div><h2 id=on-the-host-1>On the host</h2><p>Unmount everything and clean up any remaining artifacts:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>umount /mnt/chroot/boot
umount /mnt/chroot/sys
umount /mnt/chroot/proc
umount /mnt/chroot/dev/pts
umount /mnt/chroot/dev
umount /mnt/chroot
cryptsetup close crypted
umount /mnt/original
rm -d /mnt/chroot
rm -d /mnt/original
kpartx -d <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/ubuntu-base.img&#34;</span>
kpartx -d <span style=color:#e6db74>&#34;</span>$PWD<span style=color:#e6db74>/ubuntu-target.img&#34;</span>
</code></pre></div><p>You are now ready to flash <code>ubuntu-target.img</code> to an SD card.</p><h2 id=on-the-raspberry-pi>On the Raspberry Pi</h2><p>Boot the Raspberry Pi with the new SD card. It will obtain an IP address from the DHCP server and start listening for SSH connections. To decrypt the root partition and continue boot, from any shell, simply run <code>cryptroot-unlock</code>.</p><p>Once booted into the decrypted system, you will notice that the root partition is still sized at ~3GB, no matter how much space you have on the SD card. To fix this, delete and recreate the partition, this time using all available space, then follow up with cryptsetup and ext4 resize:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>echo -e <span style=color:#e6db74>&#34;d\n2\nn\np\n2\n\n\nw&#34;</span> | fdisk /dev/mmcblk0
cryptsetup resize crypted
resize2fs /dev/mapper/crypted
</code></pre></div><p>Finally, reboot the system for good measure:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>reboot
</code></pre></div><h2 id=avoiding-ssh-key-collisions>Avoiding SSH key collisions</h2><p>To avoid host key collisions you can configure a separate trusted hosts store in the <code>~/.ssh/config</code> of your client:</p><pre><code class=language-ssh data-lang=ssh>Host box
	Hostname 192.168.0.30
	User root

Host box-initramfs
	Hostname 192.168.0.30
	User root
	UserKnownHostsFile ~/.ssh/known_hosts.initramfs
</code></pre><p>Alternately, you can point to <code>~/.ssh/known_hosts.initramfs</code> from the command line:</p><pre><code class=language-ssh data-lang=ssh>ssh -o UserKnownHostsFile=~/.ssh/known_host.initramfs root@192.168.0.30
</code></pre><h2 id=resources>Resources</h2><ul><li><a href=https://www.kali.org/docs/arm/raspberry-pi-with-luks-disk-encryption/>https://www.kali.org/docs/arm/raspberry-pi-with-luks-disk-encryption/</a></li><li><a href=https://wiki.archlinux.org/index.php/Dm-crypt/Specialties>https://wiki.archlinux.org/index.php/Dm-crypt/Specialties</a></li><li><a href=https://wiki.gentoo.org/wiki/Custom_Initramfs>https://wiki.gentoo.org/wiki/Custom_Initramfs</a></li><li><a href="https://www.raspberrypi.org/forums/viewtopic.php?t=252980">https://www.raspberrypi.org/forums/viewtopic.php?t=252980</a></li><li><a href=https://thej6s.com/articles/2019-03-05__decrypting-boot-drives-remotely/>https://thej6s.com/articles/2019-03-05__decrypting-boot-drives-remotely/</a></li><li><a href=https://www.pbworks.net/ubuntu-guide-dropbear-ssh-server-to-unlock-luks-encrypted-pc/>https://www.pbworks.net/ubuntu-guide-dropbear-ssh-server-to-unlock-luks-encrypted-pc/</a></li></ul></article></div></div><div class="col-md-3 py-4"><div class="bg-light shadow p-4 rounded mb-2 bg-light"><h4>Table of content</h4><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#requirements>Requirements</a></li><li><a href=#on-the-host>On the host</a></li><li><a href=#in-the-chroot>In the chroot</a><ul><li><a href=#prepare>Prepare</a></li><li><a href=#device-configuration>Device configuration</a></li><li><a href=#cryptsetup>Cryptsetup</a></li><li><a href=#ssh>SSH</a></li><li><a href=#build-initramfs>Build initramfs</a></li><li><a href=#cleanup>Cleanup</a></li></ul></li><li><a href=#on-the-host-1>On the host</a></li><li><a href=#on-the-raspberry-pi>On the Raspberry Pi</a></li><li><a href=#avoiding-ssh-key-collisions>Avoiding SSH key collisions</a></li><li><a href=#resources>Resources</a></li></ul></nav></div><div class="bg-light shadow p-4 rounded mt-2 bg-light"><h4>Share article with</h4><ul><li><a target=blank class=text-info href="https://twitter.com/share?text=Raspberry%20Pi%20Encrypted%20Boot%20With%20Ssh&url=https%3a%2f%2fhabet.dev%2fblog%2fraspberry-pi-encrypted-boot-with-ssh%2f">Twitter</a></li><li><a target=blank class=text-success href="https://api.whatsapp.com/send?text=Raspberry%20Pi%20Encrypted%20Boot%20With%20Ssh: https%3a%2f%2fhabet.dev%2fblog%2fraspberry-pi-encrypted-boot-with-ssh%2f" data-action=share/whatsapp/share>Whatsapp</a></li><li><a class=text-danger target=blank href="mailto:?subject=Raspberry%20Pi%20Encrypted%20Boot%20With%20Ssh&body=Check out this site https%3a%2f%2fhabet.dev%2fblog%2fraspberry-pi-encrypted-boot-with-ssh%2f">Email</a></li></ul></div></div></div></div></section><footer><div class="news container py-3" data-aos=fade-up data-aos-easing=linear data-aos-once=true><div class="h3 text-center text-dark py-3 font-weight-bold">Recent posts</div><div class="row justify-content-center"><div class="col-lg-4 col-md-6 pt-2"><a href=../../blog/self-hosting-and-securing-web-services-out-of-your-home-with-cloudflare-tunnel/ class=post-card-link><div class="card h-100"><div class="card-head px-2 py-3"><h5 class="card-title font-weight-bold px-2">Self Hosting and Securing Web Services Out of Your Home With Cloudflare Tunnel</h5><div class=px-2>Why a tunnel? Opening up a port on a home network isn’t the greatest idea. It is a security risk, a hole waiting for a hacker/bot to sneak in using a known vulnerability. Many ISP‘s and routers prevent you from opening up ports 80 and 443. Another challenge you will face is setting up a dynamic …</div></div><div class="mt-auto card-footer"><span class=float-left>December 30, 2021</span>
<a href=../../blog/self-hosting-and-securing-web-services-out-of-your-home-with-cloudflare-tunnel/ class="float-right btn btn-outline-info btn-sm">Read</a></div></div></a></div><div class="col-lg-4 col-md-6 pt-2"><a href=../../blog/raspberry-pi-encrypted-boot-with-ssh/ class=post-card-link><div class="card h-100"><div class="card-head px-2 py-3"><h5 class="card-title font-weight-bold px-2">Raspberry Pi Encrypted Boot With Ssh</h5><div class=px-2>Please note this project is a fork from ViRb3, I&rsquo;ve made some minor changes here.
Tested on Raspberry Pi 3B & 4B with Ubuntu Server 21.04 & Debian 11
Introduction This guide will show you how to encrypt your Raspberry Pi&rsquo;s root partition and set up an initramfs that will prompt …</div></div><div class="mt-auto card-footer"><span class=float-left>December 23, 2021</span>
<a href=../../blog/raspberry-pi-encrypted-boot-with-ssh/ class="float-right btn btn-outline-info btn-sm">Read</a></div></div></a></div><div class="col-lg-4 col-md-6 pt-2"><a href=../../blog/self-hosted/ class=post-card-link><div class="card h-100"><div class="card-head px-2 py-3"><h5 class="card-title font-weight-bold px-2">Self Hosted</h5><div class=px-2>This blog is self hosted on a small raspberry pi. Smaller than the size of your hand. I choose this model with a Crucial SSD you can find here. You’ll need a wire like this to connect them.
Lid closed
Lid open
Raspberry pi sever
The OS of choice is Debian 11 because of its stability. I always …</div></div><div class="mt-auto card-footer"><span class=float-left>December 19, 2021</span>
<a href=../../blog/self-hosted/ class="float-right btn btn-outline-info btn-sm">Read</a></div></div></a></div></div></div><div class=text-center><span class=px-1><a class="text-dark text-decoration-none" href=https://github.com/abe-101 aria-label=github><svg xmlns="http://www.w3.org/2000/svg" width="2.7em" height="2.7em" viewBox="0 0 1792 1792"><path d="M522 1352q-8 9-20-3-13-11-4-19 8-9 20 3 12 11 4 19zm-42-61q9 12 0 19-8 6-17-7t0-18q9-7 17 6zm-61-60q-5 7-13 2-10-5-7-12 3-5 13-2 10 5 7 12zm31 34q-6 7-16-3-9-11-2-16 6-6 16 3 9 11 2 16zm129 112q-4 12-19 6-17-4-13-15t19-7q16 5 13 16zm63 5-16 11q-17 2-17-11l16-11q17-2 17 11zm58-10q2 10-14 14t-18-8 14-15q16-2 18 9zm964-956v960q0 119-84.5 203.5T1376 1664h-224q-16 0-24.5-1t-19.5-5-16-14.5-5-27.5v-239q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-121-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 492 446q-44 113-7 204-79 85-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-40 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 103t.5 68q0 22-11 33.5t-22 13-33 1.5H416q-119 0-203.5-84.5T128 1376V416q0-119 84.5-203.5T416 128h960q119 0 203.5 84.5T1664 416z"/></svg></a></span><span class=px-1><a class="text-white text-decoration-none" href=https://linkedin.com/in/abe101 aria-label=linkedin><svg xmlns="http://www.w3.org/2000/svg" width="2.4em" height="2.4em" fill="#fff" aria-label="LinkedIn" viewBox="0 0 512 512"><rect width="512" height="512" fill="#0077b5" rx="15%"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg></a></span><a class="text-info text-decoration-none" href=https://twitter.com/habet_dot_dev aria-label=twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48" height="48"><path fill="#03a9f4" d="M42 37c0 2.762-2.239 5-5 5H11c-2.762.0-5-2.238-5-5V11c0-2.762 2.238-5 5-5h26c2.761.0 5 2.238 5 5V37z"/><path fill="#fff" d="M36 17.12c-.882.391-1.999.758-3 .88 1.018-.604 2.633-1.862 3-3-.951.559-2.671 1.156-3.793 1.372C31.311 15.422 30.033 15 28.617 15 25.897 15 24 17.305 24 20v2c-4 0-7.9-3.047-10.327-6-.427.721-.667 1.565-.667 2.457.0 1.819 1.671 3.665 2.994 4.543-.807-.025-2.335-.641-3-1 0 .016.0.036.0.057.0 2.367 1.661 3.974 3.912 4.422C16.501 26.592 16 27 14.072 27c.626 1.935 3.773 2.958 5.928 3-1.686 1.307-4.692 2-7 2-.399.0-.615.022-1-.023C14.178 33.357 17.22 34 20 34c9.057.0 14-6.918 14-13.37.0-.212-.007-.922-.018-1.13C34.95 18.818 35.342 18.104 36 17.12"/></svg></a></div><div class="container bg-transparent py-4"><div class="row justify-content-center"><div class="col-md-4 text-center order-2 order-lg-1 order-md-1"><div class=pb-2><a href=https://habet.dev><img alt="Footer logo" src=../../images/fav.png height=40px width=40px></a></div>&copy; 2022 All Rights Reserved<div>Made with &#10084; and
<a href=https://github.com/gurusabarish/hugo-profile target=_blank>Hugo profile</a>
| Designed and Developed by
<a href=https://www.linkedin.com/in/gurusabarish/ target=_blank>Gurusabarish</a></div></div></div></div></footer><script>$(function(){$('[data-toggle="tooltip"]').tooltip()})</script><script>$('.darkmode-label').click(function(){$("body").toggleClass("darkmode");$(".fa-moon").toggleClass("d-none");$(".fa-sun").toggleClass("d-none");$("nav").toggleClass("navbar-dark");$("nav").toggleClass("navbar-light");$('.text-dark').addClass('darkmode-text-dark').removeClass('text-dark');$('.text-muted').addClass('darkmode-text-muted').removeClass('text-muted');if($('input.custom-control-input').is(':checked')){$('.darkmode-text-dark').addClass('text-dark').removeClass('darkmode-text-dark');$('.darkmode-text-muted').addClass('text-muted').removeClass('darkmode-text-muted');};});if($('input.custom-control-input').is(':checked')){$("body").toggleClass("darkmode");$(".fa-moon").addClass("d-none");$(".fa-sun").removeClass("d-none");$("nav").toggleClass("navbar-dark");$("nav").toggleClass("navbar-light");$('.text-dark').addClass('darkmode-text-dark').removeClass('text-dark');$('.text-muted').addClass('darkmode-text-muted').removeClass('text-muted');};</script></body></html>